---
title: "yeast_timecourse_qc"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{yeast_timecourse_qc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(brentlabRnaSeqTools)
library(scales)
```

```{r, include=FALSE}
# you can use this codeblock to read in the raw counts by reading in all of the raw count files from your align_count directory. Note: if you have both yeast and crypto raw counts, there will be some issues you'll need to address here. If you have only one organism in your align_counts_results dir, this works directly

# get counts by collating the run count output
username = "chasem"
path_list = Sys.glob(paste0("/mnt/htcf_scratch/",username, "/rnaseq_pipeline/align_count_results/*/*raw*"))
df_list = lapply(path_list, read_csv)
# the following is in genome_files -- it is in your rnaseq_pipeline directory
gene_id_path = '/home/chase/Desktop/rnaseq_pipeline/rnaseq_pipeline/genome_files/S288C_R64/S288C_R64_gids'
gene_id_col = read_csv(gene_id_path, col_names = "gene_id")
df_list = lapply(df_list, function(x) select(x, -gene_id))

raw_counts = bind_cols(df_list)

# get metadata from the sheet used to create the align_count_results output
sample_metadata_csv = "cst6_sample_data.csv"
sample_metadata = read_csv(paste0("/mnt/htcf_scratch/",username, "/rnaseq_pipeline/query/", sample_metadata_csv))

```
#NOTE: I added cst6 sample data as stored data in this module. If you want to examine different samples, you'd simply read in the metadata with read_csv
```{r}
# remove suffixes from the sample identifiers
colnames(raw_counts) = str_remove(colnames(raw_counts), "_read_count.tsv")
# remove suffix from fastqFileName col
sample_metadata$fastqFileName = str_remove(sample_metadata$fastqFileName, ".fastq.gz")
```


```{r}
# note: I added cst6 sample data as stored data in this module. If you want to examine different samples, you'd simply read in the metadata with read_csv

# ensure that the row/column order is the same
sample_raw_counts = raw_counts[, sample_metadata$fastqFileName]

# check to ensure that the raw counts columns are in the same order as the metadata rows
all.equal(colnames(sample_raw_counts), sample_metadata$fastqFileName)

```

```{r}
dds = DESeqDataSetFromMatrix(colData = sample_metadata, countData = sample_raw_counts, design=~timePoint+treatment)
```

```{r}
# not necessary for this analysis -- could call estimateSizeFactors instead to get normalized counts -- but if you wanted to look at DE, you could
deseq_obj = DESeq(dds)
```
```{r}
sample_norm_counts = counts(deseq_obj, normalized=TRUE)
rownames(sample_norm_counts) = gene_id_col$gene_id
```

```{r}
#' metadata_df has lowercase columns of standard format from database
#' norm_counts MUST have rownames assigned to the gene_ids includes at least all samples in metadata
#' metadata$fastqFileName is equal in format to colnames(raw_counts)
graphTimeCourse = function(metadata_df, genotype_1, gene_id, norm_counts){
  fltr_metadata = metadata_df %>% filter(genotype1 == genotype_1)

  norm_count_long_df = tibble(fastqFileName = fltr_metadata$fastqFileName, norm_count = norm_counts[gene_id, fltr_metadata$fastqFileName])
  
  timecourse_graph = norm_count_long_df %>% 
    left_join(metadata_df) %>%
      ggplot(aes(timePoint, norm_count, color=treatment))+
      geom_line(aes(group=interaction(libraryDate, treatment, replicate)))+
      geom_point()+
      scale_y_continuous(trans = log2_trans(),
                         breaks = trans_breaks("log2", function(x) 2^x),
                         labels = trans_format("log2", math_format(2^.x)))+
      ggtitle(genotype_1)+
      facet_wrap(~runNumber+libraryDate)
    return(timecourse_graph)
}

# again, note that the sample_norm_counts need rownames assigned to the gene_ids
x = graphTimeCourse(sample_metadata, 'CST6', 'YIL036W', sample_norm_counts)
```


# NOTE: the stuff below is miscellaneous code from an older iteration of this that I haven't gone through yet. I'm keeping it until I do in case there is something useful.

```{r}
# in order CST6, RGM1, GAL4, RGT1, which is order of unique(query_df$genotype)
tf_systematic_names = c('YIL036W', 'YMR182C', 'YPL248C','YKL038W')
names(tf_systematic_names) = unique(query_df$genotype)

# create connected line graphs of each tf in tf_systematic_names
for (name in names(tf_systematic_names)){
  gene_symbol = name
  systematic_name = tf_systematic_names[[name]]
  g = norm_count_meta_df %>%
    filter(genotype == gene_symbol, gene_id == systematic_name) %>%
    ggplot(aes(timePoint, norm_count, color=treatment))+
    geom_line(aes(group=interaction(libraryDate, treatment, replicate)))+
    geom_point()+
    scale_y_continuous(trans = log2_trans(),
                       breaks = trans_breaks("log2", function(x) 2^x),
                       labels = trans_format("log2", math_format(2^.x)))+
    ggtitle(gene_symbol)+
    facet_wrap(~runNumber+libraryDate)
    print(g)
  
}

# visualize number of DE genes at different thresholds
# do this to get all counts conditions
de_total_df = de_results_df %>%
  group_by(library_conditions) %>%
  count() %>%
  rename(total = n) 

# filter -- change values of filter to examine different thresholds
de_change_df = de_results_df %>%
  filter(padj < .05, log2FoldChange > .7) %>%
  group_by(library_conditions) %>%
  count() %>%
  rename(filtered_total = n)

# merge
num_de_genes_df = left_join(de_total_df, de_change_df)
# set NA values in filtered_total (rows with no DE genes) to 0
num_de_genes_df$filtered_total[is.na(df$filtered_total)] = 0

# drop the total column and keep only the filtered_total
num_de_genes_df = num_de_genes_df %>%
  select(filtered_total)

# add columns genotype, treatment, timepoint_contrast for graphing
num_de_genes_df$genotype = rep(c('CST6', 'GAL4', 'RGM1', 'RGT1'), each=8)
num_de_genes_df$treatment = rep(c('Estradiol', 'EtOH'), each = 4, times = 4)
num_de_genes_df$timepoint_contrast = rep(c('1_15', '1_20', '1_30', '1_90'), times = 8)

# force NA to 0 if there are no de genes
num_de_genes_df[is.na(num_de_genes_df)] = 0

# visualize number of differentiallye expressed genes
num_de_genes_df %>%
  ggplot(aes(timepoint_contrast, fill = treatment))+
    geom_bar(aes(weight=filtered_total), position='dodge')+
    scale_y_continuous(trans = log2_trans(),
                     breaks = trans_breaks("log2", function(x) 2^x),
                     labels = trans_format("log2", math_format(2^.x)))+
    facet_wrap(~genotype)
```



