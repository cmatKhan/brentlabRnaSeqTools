<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>running_the_nextflow_pipeline • brentlabRnaSeqTools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="running_the_nextflow_pipeline">
<meta property="og:description" content="brentlabRnaSeqTools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brentlabRnaSeqTools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/create_nextflow_samplesheet.html">create_nextflow_samplesheet</a>
    </li>
    <li>
      <a href="../articles/create_set.html">create_set</a>
    </li>
    <li>
      <a href="../articles/database_interaction.html">database_interaction</a>
    </li>
    <li>
      <a href="../articles/experiment_sets.html">experiment_sets</a>
    </li>
    <li>
      <a href="../articles/genomics_tools.html">genomics_tools</a>
    </li>
    <li>
      <a href="../articles/install_nf_co_rnaseq_pipeline.html">install_nf_co_rnaseq_pipeline</a>
    </li>
    <li>
      <a href="../articles/running_the_nextflow_pipeline.html">running_the_nextflow_pipeline</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmatKhan/brentlabRnaSeqTools/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="running_the_nextflow_pipeline_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>running_the_nextflow_pipeline</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmatKhan/brentlabRnaSeqTools/blob/master/vignettes/running_the_nextflow_pipeline.Rmd"><code>vignettes/running_the_nextflow_pipeline.Rmd</code></a></small>
      <div class="hidden name"><code>running_the_nextflow_pipeline.Rmd</code></div>

    </div>

    
    
<div id="run-the-nextflow-pipeline" class="section level1">
<h1 class="hasAnchor">
<a href="#run-the-nextflow-pipeline" class="anchor"></a>Run the nextflow pipeline</h1>
<p>This is a bit of a misnomer – nextflow is simply the language. The pipeline is from <a href="https://nf-co.re/">nf-co.re</a>, which is a highly curated repository for nextflow pipelines. There is only one pipeline for any given task, meaning there will not be 10 different rnaseq_pipelines. Rather, all development for rnaseq is happening in one spot.</p>
<p>There are two options – you can read the <a href="https://nf-co.re/rnaseq/3.3/parameters">parameter docs</a> to figure out how to input your data, or you can click the “launch version #.#” button in the header of page. There is a form you can fill out which will create the parameters.json document, and also tell you what the command will look like.</p>
<p>Here is an example of what submitting to the pipeline looks like</p>
<div id="sample-sheet" class="section level2">
<h2 class="hasAnchor">
<a href="#sample-sheet" class="anchor"></a>Sample sheet</h2>
<pre class="raw"><code>
sample fastq_1                                                               fastq_2 strandedness
269    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_4178_samples/Brent_J... ""      reverse     
270    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_4040_samples/Brent_s... ""      reverse     
278    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_4040_samples/Brent_s... ""      reverse     
306    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_1658_samples/1658_Br... ""      reverse     
307    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_1658_samples/1658_Br... ""      reverse     
308    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_1658_samples/1658_Br... ""      reverse     
</code></pre>
</div>
<div id="move-the-fastq-files-to-scratch" class="section level2">
<h2 class="hasAnchor">
<a href="#move-the-fastq-files-to-scratch" class="anchor"></a>Move the fastq files to scratch</h2>
<p>For those computational people, what you need to do is move the files from lts to scratch. Use your favorite method.</p>
<p>If you wish to use my methods, here is how I do it:</p>
<p>In the brentlabRnaSeqTools there is a function called <code><a href="../reference/moveNfCoFastqFiles.html">moveNfCoFastqFiles()</a></code> which creates a two column dataframe of structure column1: source, column2: destination. I write that to the cluster and then use the bash script below to move the files. Here is my full process, using crypto as an example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">prefix</span> <span class="op">=</span> <span class="st">"/lts/mblab/Crypto/rnaseq_data/lts_sequence"</span>

<span class="va">lookup</span> <span class="op">=</span> <span class="fu"><a href="../reference/moveNfCoFastqFiles.html">moveNfCoFastqFiles</a></span><span class="op">(</span><span class="va">sample_sheet</span>, <span class="va">prefix</span><span class="op">)</span>

<span class="co"># from my local with the cluster mounted</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_tsv</a></span><span class="op">(</span><span class="va">lookup</span>, <span class="st">"/scratch/mblab/chasem/rnaseq_pipeline/lookups/my_lookup.tsv"</span><span class="op">)</span></code></pre></div>
<p>I then go over to the cluster and use a script called moveFiles.sh. It contains:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">#!/bin/bash</span></span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="va">nrow=$(</span><span class="fu">wc</span> -l <span class="va">$1</span> <span class="kw">|</span> <span class="fu">grep</span> -oP <span class="st">"^[[:digit:]]+"</span><span class="va">)</span></span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="kw">for</span> <span class="ex">i</span> in <span class="va">$(</span><span class="fu">seq</span> 1 <span class="va">$nrow)</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="bu">read</span> <span class="va">s</span> <span class="va">d</span> <span class="op">&lt;</span> <span class="op">&lt;(</span><span class="fu">sed</span> -n <span class="va">${i}</span>p <span class="va">$1</span><span class="op">)</span></span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a>    <span class="va">dest_dir=$(</span><span class="fu">dirname</span> <span class="va">$d)</span> </span>
<span id="cb3-11"><a href="#cb3-11"></a>    </span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="fu">mkdir</span> -p <span class="va">$dest_dir</span></span>
<span id="cb3-13"><a href="#cb3-13"></a></span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="bu">echo</span> <span class="st">"copying </span><span class="va">$1</span><span class="st"> of </span><span class="va">$nrow</span><span class="st">"</span></span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a>    <span class="fu">rsync</span> -aHv <span class="va">$s</span> <span class="va">$d</span></span>
<span id="cb3-17"><a href="#cb3-17"></a></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="kw">done</span></span></code></pre></div>
<p>So from the command line I do this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">./job_scripts/moveFiles.sh</span> lookups/my_lookup.tsv</span></code></pre></div>
</div>
<div id="params" class="section level2">
<h2 class="hasAnchor">
<a href="#params" class="anchor"></a>params</h2>
<p>NOTE! This is not necessarily a “standard” parameter file – in particular, the feature_group_type is " and we are skipping the biotype_qc. This is necessary for crypto since there is no biotype information in the GTF. This should not be the case, however, certainly will not be true if you are processing human and mouse data.</p>
<pre class="raw"><code>
{
    "input": "\/scratch\/mblab\/chasem\/rnaseq_pipeline\/daniel_set\/daniel_sample.csv",
    "outdir": ".\/daniel_set_results",
    "gtf": "/scratch\/mblab/chasem\/rnaseq_pipeline\/genome_files_curr\/KN99\/liftoff_h99_to_kn99.gtf",
    "fasta": "\/scratch\/mblab/chasem\/rnaseq_pipeline\/genome_files_curr\/KN99\/KN99_genome_fungidb.fasta",
    "gtf_extra_attributes": "ID",
    "featurecounts_group_type": "",
    "rseqc_modules": "bam_stat,inner_distance,infer_experiment,junction_annotation,junction_saturation,read_distribution,read_duplication",
    "skip_bigwig": true,
    "skip_biotype_qc": true
}
</code></pre>
</div>
<div id="nextflow-command" class="section level2">
<h2 class="hasAnchor">
<a href="#nextflow-command" class="anchor"></a>nextflow command</h2>
<pre class="raw"><code>#!/bin/bash

#SBATCH --time=15:00:00  # right now, 15 hours. change depending on time expectation to run
#SBATCH --mem-per-cpu=5G
#SBATCH -J your_run_name
#SBATCH -o ./your_output_name.out

ml miniconda
ml singularity

source activate /path/to/your/conda_env/nextflow

work_folder_name=work_today

config_path=/scratch/mblab/$USER/configs/conf/wustl_htcf.config

param_file=/scratch/mblab/$USER/param.json

# yes -- keep this here
mkdir -p tmp

# note! -r 3.3 is the 'revision' or version of the nf-co/rnaseq pipeline you wish to use.
# You should use the most up to date version, unless you are holding the version constant
# for consistency across a set

nextflow run nf-core/rnaseq -r 3.3 \
                            -work-dir ${PWD}/${work_folder_name} \
                            -c ${config_path} \
                            -params-file ${param_file}
</code></pre>
</div>
</div>
<div id="the-resume-function" class="section level1">
<h1 class="hasAnchor">
<a href="#the-resume-function" class="anchor"></a>the Resume function</h1>
<p>Oh no! your pipeline errored half way through. Do the following:</p>
<ol style="list-style-type: decimal">
<li>read the error message carefully and see if you can fix the issue on your own. For example, are all your input paths correct?</li>
<li>save the error message and send it to someone else.</li>
<li>get on the nf-co/rnaseq_pipeline slack channel (you’ll find the link on their site). They are <em>very</em> helpful, and part of the reason we switched to this pipeline is to get access to a wider community of bioinformatians</li>
</ol>
<p>When you think you ahve resolved the issue, just add the <code>-resume</code> flag to your command like so and resubmit:</p>
<pre class="raw"><code>#!/bin/bash

#SBATCH --time=15:00:00  # right now, 15 hours. change depending on time expectation to run
#SBATCH --mem-per-cpu=5G
#SBATCH -J your_run_name
#SBATCH -o ./your_output_name.out

ml miniconda
ml singularity

source activate /path/to/your/conda_env/nextflow

work_folder_name=work_today

config_path=/scratch/mblab/$USER/configs/conf/wustl_htcf.config

param_file=/scratch/mblab/$USER/param.json

# yes -- keep this here
mkdir -p tmp

# note! -r 3.3 is the 'revision' or version of the nf-co/rnaseq pipeline you wish to use.
# You should use the most up to date version, unless you are holding the version constant
# for consistency across a set

nextflow run nf-core/rnaseq -r 3.3 \
                            -work-dir ${PWD}/${work_folder_name} \
                            -c ${config_path} \
                            -params-file ${param_file} \
                            -resume # see how easy that is!</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Chase Mateusiak.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
