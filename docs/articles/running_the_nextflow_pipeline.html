<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>running_the_nextflow_pipeline • brentlabRnaSeqTools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="running_the_nextflow_pipeline">
<meta property="og:description" content="brentlabRnaSeqTools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brentlabRnaSeqTools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/create_nextflow_samplesheet.html">create_nextflow_samplesheet</a>
    </li>
    <li>
      <a href="../articles/create_set.html">create_set</a>
    </li>
    <li>
      <a href="../articles/database_interaction.html">database_interaction</a>
    </li>
    <li>
      <a href="../articles/experiment_sets.html">experiment_sets</a>
    </li>
    <li>
      <a href="../articles/running_the_nextflow_pipeline.html">running_the_nextflow_pipeline</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmatKhan/brentlabRnaSeqTools/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="running_the_nextflow_pipeline_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>running_the_nextflow_pipeline</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmatKhan/brentlabRnaSeqTools/blob/master/vignettes/running_the_nextflow_pipeline.Rmd"><code>vignettes/running_the_nextflow_pipeline.Rmd</code></a></small>
      <div class="hidden name"><code>running_the_nextflow_pipeline.Rmd</code></div>

    </div>

    
    
<div id="create-an-environment-with-nextflow" class="section level1">
<h1 class="hasAnchor">
<a href="#create-an-environment-with-nextflow" class="anchor"></a>Create an environment with nextflow</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /scratch/mblab/<span class="va">$USER</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># launch an interactive session</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--mem</span><span class="op">=</span>20000 <span class="at">--cpus-per-task</span><span class="op">=</span>1 <span class="at">-J</span> interactive <span class="at">-p</span> interactive <span class="at">--pty</span> /bin/bash <span class="at">-l</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># note: there are no promises that this package works. My suggestion is that you use your own installation of conda</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ex">ml</span> miniconda</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> conda_envs</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># this will create the environment directory in your scratch space (yes, it may be deleted. you'd have to make a new one when that happens), and installs nextflow into it</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="ex">create</span> create <span class="at">-p</span> conda_envs/nextflow nextflow</span></code></pre></div>
</div>
<div id="launch-the-environment-and-test-nextflow" class="section level1">
<h1 class="hasAnchor">
<a href="#launch-the-environment-and-test-nextflow" class="anchor"></a>Launch the environment and test nextflow</h1>
<p><em>Not</em> with <code>conda activate nextflow</code>. Because you created this outside of your <code>$CONDA_HOME</code>, you have to provide the path like so:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># do this if you are not already there</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /scratch/mblab/<span class="va">$USER</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--mem</span><span class="op">=</span>20000 <span class="at">--cpus-per-task</span><span class="op">=</span>1 <span class="at">-J</span> interactive <span class="at">-p</span> interactive <span class="at">--pty</span> /bin/bash <span class="at">-l</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ml</span> miniconda</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># activate the environment</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> activate ./conda_envs/nextflow</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run hello <span class="co"># note: might take a few minutes</span></span></code></pre></div>
</div>
<div id="download-the-configuration-files" class="section level1">
<h1 class="hasAnchor">
<a href="#download-the-configuration-files" class="anchor"></a>Download the configuration files</h1>
<p>You could put this in <code>$HOME</code>, if you want, to avoid having it garbage collected</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/cmatKhan/configs.git</span></code></pre></div>
</div>
<div id="run-the-nextflow-pipeline" class="section level1">
<h1 class="hasAnchor">
<a href="#run-the-nextflow-pipeline" class="anchor"></a>Run the nextflow pipeline</h1>
<p>This is a bit of a misnomer – nextflow is simply the language. The pipeline is from <a href="https://nf-co.re/">nf-co.re</a>, which is a highly curated repository for nextflow pipelines. There is only one pipeline for any given task, meaning there will not be 10 different rnaseq_pipelines. Rather, all development for rnaseq is happening in one spot.</p>
<p>There are two options – you can read the <a href="https://nf-co.re/rnaseq/3.3/parameters">parameter docs</a> to figure out how to input your data, or you can click the “launch version #.#” button in the header of page. There is a form you can fill out which will create the parameters.json document, and also tell you what the command will look like.</p>
<p>Here is an example of what submitting to the pipeline looks like</p>
<div id="sample-sheet" class="section level2">
<h2 class="hasAnchor">
<a href="#sample-sheet" class="anchor"></a>Sample sheet</h2>
<pre class="raw"><code>
sample fastq_1                                                               fastq_2 strandedness
269    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_4178_samples/Brent_J... ""      reverse     
270    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_4040_samples/Brent_s... ""      reverse     
278    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_4040_samples/Brent_s... ""      reverse     
306    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_1658_samples/1658_Br... ""      reverse     
307    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_1658_samples/1658_Br... ""      reverse     
308    /lts/mblab/Crypto/rnaseq_data/lts_sequence/run_1658_samples/1658_Br... ""      reverse     
</code></pre>
</div>
<div id="move-the-fastq-files-to-scratch" class="section level2">
<h2 class="hasAnchor">
<a href="#move-the-fastq-files-to-scratch" class="anchor"></a>Move the fastq files to scratch</h2>
<p>This is a frustrating step, and one that I haven’t re-written a function for yet in the brentlabRnaSeqTools package. Right now, this is how I do it. If you are not a computational person in the lab, please just ask one of us to move the files for you</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="at">-F</span><span class="st">","</span> <span class="st">'{print $2}'</span> sample_sheet.csv <span class="op">&gt;</span> fastq_lookup.txt</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> scratch_fastqs</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> fastq_lookup.txt <span class="kw">|</span> <span class="cf">while</span> <span class="bu">read</span> <span class="va">line</span><span class="kw">;</span> <span class="cf">do</span> <span class="fu">rsync</span> <span class="at">-aHvR</span> <span class="va">$line</span> ../scratch_sequence/fastq_set/<span class="kw">;</span> <span class="cf">done</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># and then I move the run directories back up to the level that I want them -- please just ask if this doesn't make sense. Eventually there will be a function in the brentlabRnaSeqTools. If you have a better bash method, please tell me.</span></span></code></pre></div>
</div>
<div id="params" class="section level2">
<h2 class="hasAnchor">
<a href="#params" class="anchor"></a>params</h2>
<p>NOTE! This is not necessarily a “standard” parameter file – in particular, the feature_group_type is " and we are skipping the biotype_qc. This is necessary for crypto since there is no biotype information in the GTF. This should not be the case, however, certainly will not be true if you are processing human and mouse data.</p>
<pre class="raw"><code>
{
    "input": "sample_summary.csv",
    "outdir": ".\/work",
    "gtf": "crypto.gtf.gz",
    "gtf_extra_attributes": "ID",
    "featurecounts_group_type": "",
    "rseqc_modules": "bam_stat,inner_distance,infer_experiment,junction_annotation,junction_saturation,read_distribution,read_duplication,tin",
    "skip_bigwig": true,
    "skip_biotype_qc": true
}
</code></pre>
</div>
<div id="nextflow-command" class="section level2">
<h2 class="hasAnchor">
<a href="#nextflow-command" class="anchor"></a>nextflow command</h2>
<pre class="raw"><code>#!/bin/bash

#SBATCH --time=15:00:00  # right now, 15 hours. change depending on time expectation to run
#SBATCH --mem-per-cpu=5G
#SBATCH -J your_run_name
#SBATCH -o ./your_output_name.out

ml miniconda
ml singularity

source activate /path/to/your/conda_env/nextflow

work_folder_name=work_today

config_path=/scratch/mblab/$USER/configs/conf/wustl_htcf.config

param_file=/scratch/mblab/$USER/param.json

# yes -- keep this here
mkdir -p tmp

# note! -r 3.3 is the 'revision' or version of the nf-co/rnaseq pipeline you wish to use.
# You should use the most up to date version, unless you are holding the version constant
# for consistency across a set

nextflow run nf-core/rnaseq -r 3.3 \
                            -work-dir ${PWD}/${work_folder_name} \
                            -c ${config_path} \
                            -params-file ${param_file}
</code></pre>
</div>
</div>
<div id="the-resume-function" class="section level1">
<h1 class="hasAnchor">
<a href="#the-resume-function" class="anchor"></a>the Resume function</h1>
<p>Oh no! your pipeline errored half way through. Do the following:</p>
<ol style="list-style-type: decimal">
<li>read the error message carefully and see if you can fix the issue on your own. For example, are all your input paths correct?</li>
<li>save the error message and send it to someone else.</li>
<li>get on the nf-co/rnaseq_pipeline slack channel (you’ll find the link on their site). They are <em>very</em> helpful, and part of the reason we switched to this pipeline is to get access to a wider community of bioinformatians</li>
</ol>
<p>When you think you ahve resolved the issue, just add the <code>-resume</code> flag to your command like so and resubmit:</p>
<pre class="raw"><code>#!/bin/bash

#SBATCH --time=15:00:00  # right now, 15 hours. change depending on time expectation to run
#SBATCH --mem-per-cpu=5G
#SBATCH -J your_run_name
#SBATCH -o ./your_output_name.out

ml miniconda
ml singularity

source activate /path/to/your/conda_env/nextflow

work_folder_name=work_today

config_path=/scratch/mblab/$USER/configs/conf/wustl_htcf.config

param_file=/scratch/mblab/$USER/param.json

# yes -- keep this here
mkdir -p tmp

# note! -r 3.3 is the 'revision' or version of the nf-co/rnaseq pipeline you wish to use.
# You should use the most up to date version, unless you are holding the version constant
# for consistency across a set

nextflow run nf-core/rnaseq -r 3.3 \
                            -work-dir ${PWD}/${work_folder_name} \
                            -c ${config_path} \
                            -params-file ${param_file} \
                            -resume # see how easy that is!</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Chase Mateusiak.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
